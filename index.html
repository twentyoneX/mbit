<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>mBIT v6 (Instant Thread)</title>
<script src="https://unpkg.com/nostr-tools@1.17.0/lib/nostr.bundle.js"></script>
<style>
    :root { --bg: #000; --txt: #fff; --acc: #00FF41; --brd: #333; --pnl: #111; font-family: monospace; }
    body { background: var(--bg); color: var(--txt); margin: 0; padding: 10px; padding-bottom: 80px; max-width: 600px; margin: 0 auto; }
    
    /* UTILS */
    .hidden { display: none !important; }
    button { background: var(--txt); color: #000; border: none; padding: 8px 15px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
    button:hover { opacity: 0.8; }
    button.sec { background: #333; color: #fff; border: 1px solid #555; }
    input, textarea { background: #000; color: #fff; border: 1px solid #333; padding: 10px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }

    /* LAYOUT */
    header { text-align: center; border-bottom: 1px solid var(--brd); padding: 10px; margin-bottom: 20px; }
    h1 { margin: 0; text-shadow: 0 0 5px var(--acc); }
    .nav { display: flex; justify-content: center; gap: 15px; user-select: none; margin-top: 10px; }
    .nav span { cursor: pointer; opacity: 0.7; }
    .nav span:hover { opacity: 1; color: var(--acc); text-decoration: underline; }
    
    .panel { display: none; }
    .panel.active { display: block; }
    
    /* POST CARD */
    .post { border: 1px solid var(--brd); padding: 15px; margin-bottom: 15px; background: #050505; word-wrap: break-word; }
    .post-meta { color: #888; font-size: 0.8em; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    .avatar { width: 30px; height: 30px; background: #333; border-radius: 50%; object-fit: cover; margin-right: 10px; vertical-align: middle; }
    .post-content { font-size: 1em; line-height: 1.4; white-space: pre-wrap; }
    .post-actions { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #333; display: flex; gap: 10px; flex-wrap: wrap; }
    .media { max-width: 100%; margin-top: 10px; border: 1px solid #333; display: block; }
    
    /* THREAD VIEW */
    .thread-ancestor { border-left: 2px dotted #555; padding-left: 15px; margin-bottom: 10px; opacity: 0.8; font-size: 0.9em; }
    .thread-main { border: 2px solid var(--acc); background: #081008; margin: 20px 0; padding: 15px; }
    .thread-reply { margin-left: 15px; border-left: 2px solid #333; padding-left: 10px; }
    
    /* NOTIFICATIONS */
    .notif { padding: 15px; border-bottom: 1px solid var(--brd); cursor: pointer; display: flex; gap: 10px; }
    .notif:hover { background: #111; }

    /* FOOTER & FAB */
    .footer { position: fixed; bottom: 0; left: 0; width: 100%; background: #000; border-top: 1px solid var(--brd); display: flex; justify-content: center; gap: 20px; padding: 15px; z-index: 100; }
    .fab { position: fixed; bottom: 80px; right: 20px; width: 50px; height: 50px; background: var(--acc); color: #000; border-radius: 50%; font-size: 30px; display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 100; }
    
    /* MODAL */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 200; }
    .modal-content { background: #111; border: 1px solid var(--acc); padding: 20px; width: 90%; max-width: 500px; }
</style>
</head>
<body>

<header>
    <h1>mBIT</h1>
    <div class="nav">
        <span onclick="route('feed')">#FEED</span>
        <span onclick="route('notifs')">#NOTIFS</span>
        <span onclick="route('profile')">#PROFILE</span>
        <span onclick="route('settings')">#SETTINGS</span>
    </div>
</header>

<!-- FEED PANEL -->
<div id="feed-panel" class="panel active">
    <div id="feed-list">Loading global feed...</div>
</div>

<!-- THREAD PANEL -->
<div id="thread-panel" class="panel">
    <button class="sec" onclick="route('feed')">&lt; BACK TO FEED</button>
    
    <!-- Parent Context -->
    <div id="thread-ancestor-container" style="margin-top:20px;"></div>
    
    <!-- Main Note -->
    <div id="thread-main-container"></div>
    
    <div style="margin: 20px 0; border-bottom: 1px dashed #333; color:#888;">REPLIES:</div>
    
    <!-- Replies -->
    <div id="thread-replies-container">Loading comments...</div>
</div>

<!-- NOTIFICATIONS PANEL -->
<div id="notifs-panel" class="panel">
    <h3>>> NOTIFICATIONS</h3>
    <div id="notif-list">Please login to see notifications.</div>
</div>

<!-- SETTINGS / LOGIN -->
<div id="settings-panel" class="panel">
    <h3>>> LOGIN & SETTINGS</h3>
    <input id="pk-input" placeholder="Enter nsec key...">
    <button onclick="loginKey()">LOGIN WITH KEY</button>
    <button class="sec" onclick="loginExt()" style="margin-top:5px;">USE EXTENSION</button>
    <br><br>
    <button class="sec" onclick="logout()">LOGOUT</button>
    <div id="user-status" style="margin-top:10px; opacity:0.7;"></div>
</div>

<!-- PROFILE -->
<div id="profile-panel" class="panel">
    <h3>>> MY PROFILE</h3>
    <div id="profile-data"></div>
</div>

<!-- SEARCH -->
<div id="search-panel" class="panel">
    <h3>>> SEARCH</h3>
    <div style="display:flex;gap:10px"><input id="search-in"><button onclick="runSearch()">GO</button></div>
    <div id="search-out"></div>
</div>

<div class="fab" onclick="openComposer()">+</div>

<!-- COMPOSER MODAL -->
<div id="composer" class="modal">
    <div class="modal-content">
        <div id="reply-context-text" style="margin-bottom:10px; font-size:0.8em; opacity:0.7;"></div>
        <textarea id="compose-text" rows="5" placeholder="Type something..."></textarea>
        <div style="display:flex; gap:10px;">
            <button class="sec" style="flex:1" onclick="closeComposer()">CANCEL</button>
            <button style="flex:1" onclick="publishNote()">SEND</button>
        </div>
    </div>
</div>

<div class="footer">
    <span onclick="route('feed')">#HOME</span>
    <span onclick="route('search')">#SEARCH</span>
    <span onclick="route('notifs')">#NOTIFS</span>
</div>

<script>
// --- CONFIGURATION ---
const RELAYS = [
    'wss://relay.damus.io',
    'wss://relay.primal.net',
    'wss://nos.lol',
    'wss://relay.nostr.band'
];

// --- GLOBAL STATE ---
const pool = {};
const eventsMap = new Map(); // Global Cache
const profilesMap = {};
let myPub = localStorage.getItem('mbit_pub');
let myPriv = localStorage.getItem('mbit_priv');

// Thread State
let currentThreadId = null;
let replyToEvent = null;
let threadReplies = []; // Local array to sort replies for current thread

// --- INITIALIZATION ---
function init() {
    if(myPub) document.getElementById('user-status').innerText = "Logged in";
    
    RELAYS.forEach(url => {
        try {
            const ws = new WebSocket(url);
            pool[url] = ws;
            ws.onopen = () => {
                // Subscribe to Global Feed
                sub(ws, "feed", { kinds: [1], limit: 25 });
                // Subscribe to Notifications
                if(myPub) sub(ws, "notifs", { '#p': [myPub], kinds: [1, 6, 7, 9735], limit: 50 });
            };
            ws.onmessage = (msg) => handleMessage(msg);
        } catch(e) { console.error(e); }
    });
}

function sub(ws, id, filter) {
    ws.send(JSON.stringify(["REQ", id, filter]));
}

// --- EVENT HANDLER ---
function handleMessage(msg) {
    const data = JSON.parse(msg.data);
    if (data[0] !== 'EVENT') return;

    const subId = data[1];
    const ev = data[2];

    // Cache everything
    if (!eventsMap.has(ev.id)) {
        eventsMap.set(ev.id, ev);
        
        // Fetch Profile if missing
        if (!profilesMap[ev.pubkey]) {
            profilesMap[ev.pubkey] = {}; 
            fetchProfile(ev.pubkey);
        }

        // --- ROUTING UPDATES ---

        if (subId === 'feed') updateFeedUI();
        if (subId === 'notifs') updateNotifsUI();
        if (subId === 'search') renderSearch(ev);

        // --- THREAD HANDLING (The Fix) ---
        
        // If this event is the MAIN note we are waiting for (if it wasn't cached)
        if (subId === 'thread_main' && ev.id === currentThreadId) {
            renderThreadMain(ev);
            // Check for parent
            const pId = getParentId(ev);
            if (pId) fetchSingleNote(pId, 'thread_parent');
        }

        // If this is a REPLY to the current thread
        if (subId === 'thread_replies' || (ev.kind === 1 && getParentId(ev) === currentThreadId)) {
            // Check if it's already displayed to avoid duplication
            if(!threadReplies.find(r => r.id === ev.id)) {
                threadReplies.push(ev);
                updateThreadRepliesUI();
            }
        }

        // If this is an ANCESTOR (Parent)
        if (subId === 'thread_parent') {
            document.getElementById('thread-ancestor-container').innerHTML = `
                <div style="opacity:0.6;font-size:0.8em;">In reply to:</div>
                ${renderCard(ev, "thread-ancestor")}
            `;
        }

        // Metadata
        if (ev.kind === 0) {
            try { profilesMap[ev.pubkey] = JSON.parse(ev.content); } catch(e){}
            // Refresh UIs to show new avatar/name
            if(!document.getElementById('feed-panel').classList.contains('hidden')) updateFeedUI();
        }
    }
}

// --- THREAD ENGINE (SIMPLIFIED & ROBUST) ---

function openThread(id) {
    currentThreadId = id;
    threadReplies = []; // Reset local replies
    route('thread');
    
    // UI Reset
    document.getElementById('thread-ancestor-container').innerHTML = '';
    document.getElementById('thread-main-container').innerHTML = 'Loading note...';
    document.getElementById('thread-replies-container').innerHTML = 'Loading comments...';

    // 1. Check Cache for Main Note
    const cached = eventsMap.get(id);
    
    if (cached) {
        // Render Immediately
        renderThreadMain(cached);
        // Check for parent
        const pId = getParentId(cached);
        if (pId) fetchSingleNote(pId, 'thread_parent');
    } else {
        // Fetch from network if not in cache
        fetchSingleNote(id, 'thread_main');
    }

    // 2. Fetch Replies (Aggressively)
    Object.values(pool).forEach(ws => {
        if(ws.readyState === 1) {
            // Get all text notes referring to this ID
            sub(ws, "thread_replies", { kinds: [1], '#e': [id], limit: 100 });
        }
    });
}

function renderThreadMain(ev) {
    document.getElementById('thread-main-container').innerHTML = renderCard(ev, "thread-main");
}

function updateThreadRepliesUI() {
    // Sort by date
    threadReplies.sort((a,b) => a.created_at - b.created_at);
    
    if (threadReplies.length === 0) {
        document.getElementById('thread-replies-container').innerHTML = "No replies yet.";
    } else {
        document.getElementById('thread-replies-container').innerHTML = threadReplies.map(ev => renderCard(ev, "thread-reply")).join('');
    }
}

function fetchSingleNote(id, subLabel) {
    Object.values(pool).forEach(ws => {
        if(ws.readyState === 1) sub(ws, subLabel, { kinds: [1], ids: [id] });
    });
}

function getParentId(ev) {
    const eTags = ev.tags.filter(t => t[0] === 'e');
    if (eTags.length === 0) return null;
    const reply = eTags.find(t => t[3] === 'reply');
    if (reply) return reply[1];
    const root = eTags.find(t => t[3] === 'root');
    if (root) return root[1]; // If it's a root reply
    return eTags[eTags.length-1][1]; // Fallback NIP-10
}

// --- ROUTING ---
function route(page) {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.getElementById(page + '-panel').classList.add('active');
    if (page === 'feed') updateFeedUI();
    if (page === 'notifs') updateNotifsUI();
    if (page === 'search') document.getElementById('search-panel').classList.add('active');
}

// --- UI RENDERERS ---
function renderCard(ev, extraClass = "") {
    const p = profilesMap[ev.pubkey] || {};
    const name = p.name || p.display_name || ev.pubkey.substring(0,8);
    const pic = p.picture || '';
    
    let content = ev.content
        .replace(/</g, "&lt;")
        .replace(/(https?:\/\/[^\s]+\.(jpg|jpeg|png|gif|webp))/gi, '<img src="$1" class="media">')
        .replace(/(https?:\/\/[^\s]+\.(mp4|mov))/gi, '<video controls src="$1" class="media"></video>');

    return `
    <div class="post ${extraClass}" id="${ev.id}">
        <div class="post-meta" onclick="openThread('${ev.id}')">
            <div style="display:flex;align-items:center;">
                ${pic ? `<img src="${pic}" class="avatar">` : `<div class="avatar"></div>`}
                <b style="color:#fff">${name}</b>
            </div>
            <span>${new Date(ev.created_at * 1000).toLocaleTimeString()}</span>
        </div>
        <div class="post-content" onclick="openThread('${ev.id}')">${content}</div>
        <div class="post-actions">
            <button class="sec" onclick="prepReply('${ev.id}')">REPLY</button>
            <button class="sec" onclick="sendLike('${ev.id}', '${ev.pubkey}')">LIKE</button>
            <button class="sec" onclick="zap('${p.lud16}')">ZAP</button>
        </div>
    </div>`;
}

function updateFeedUI() {
    const list = Array.from(eventsMap.values())
        .filter(e => e.kind === 1)
        .sort((a,b) => b.created_at - a.created_at)
        .slice(0, 50);
    document.getElementById('feed-list').innerHTML = list.map(ev => renderCard(ev)).join('');
}

function updateNotifsUI() {
    if(!myPub) return;
    const list = Array.from(eventsMap.values())
        .filter(e => e.tags.some(t => t[0] === 'p' && t[1] === myPub))
        .sort((a,b) => b.created_at - a.created_at)
        .slice(0, 50);

    document.getElementById('notif-list').innerHTML = list.map(ev => {
        const p = profilesMap[ev.pubkey] || {};
        const name = p.name || ev.pubkey.substring(0,8);
        
        // Find Target Note ID (what was liked/replied to)
        let targetId = ev.tags.find(t => t[0] === 'e')?.[1];

        // Click Action: Open the original note, not the notification event
        const clickAction = targetId ? `onclick="openThread('${targetId}')"` : '';

        if(ev.kind === 7) return `<div class="notif" ${clickAction}><span style="color:red">‚ù§</span> <b>${name}</b> liked your post</div>`;
        if(ev.kind === 6) return `<div class="notif" ${clickAction}><span style="color:green">‚Üª</span> <b>${name}</b> reposted your post</div>`;
        if(ev.kind === 9735) return `<div class="notif" ${clickAction}><span style="color:gold">‚ö°</span> Zap from <b>${name}</b></div>`;
        if(ev.kind === 1) return `<div class="notif" onclick="openThread('${ev.id}')">üí¨ Reply from <b>${name}</b>:<br>${ev.content}</div>`;
        
        return '';
    }).join('');
}

function fetchProfile(pubkey) {
    Object.values(pool).forEach(ws => {
        if(ws.readyState === 1) sub(ws, "meta_" + pubkey.substring(0,5), { kinds:[0], authors:[pubkey], limit:1 });
    });
}

// --- ACTIONS ---
function prepReply(id) {
    replyToEvent = id;
    document.getElementById('reply-context-text').innerText = "Replying to: " + id.substring(0,10);
    document.getElementById('composer').style.display = 'flex';
}
function closeComposer() { document.getElementById('composer').style.display = 'none'; replyToEvent = null; }
function openComposer() { 
    if(!myPub) return alert("Login first");
    document.getElementById('composer').style.display = 'flex'; 
}

async function publishNote() {
    const txt = document.getElementById('compose-text').value;
    const ev = { kind:1, created_at:Math.floor(Date.now()/1000), tags:[], content:txt, pubkey:myPub };
    if(replyToEvent) ev.tags.push(['e', replyToEvent, '', 'reply']);
    
    // Signing logic (simplified)
    if(window.nostr) {
        const s = await window.nostr.signEvent(ev);
        Object.values(pool).forEach(w => w.send(JSON.stringify(["EVENT", s])));
    } else {
        ev.id = window.NostrTools.getEventHash(ev);
        ev.sig = window.NostrTools.signEvent(ev, myPriv);
        Object.values(pool).forEach(w => w.send(JSON.stringify(["EVENT", ev])));
    }
    closeComposer();
    document.getElementById('compose-text').value = '';
}

async function sendLike(id, pk) {
    if(!myPub) return alert("Login");
    const ev = { kind:7, content:"+", tags:[['e',id],['p',pk]], created_at:Math.floor(Date.now()/1000), pubkey:myPub };
    if(window.nostr) { const s = await window.nostr.signEvent(ev); Object.values(pool).forEach(w => w.send(JSON.stringify(["EVENT", s]))); alert("Liked"); }
}

async function zap(lud16) {
    if(!lud16) return alert("No Lightning Address");
    window.open("lightning:"+lud16);
}

// --- SEARCH ---
function runSearch() {
    const q = document.getElementById('search-in').value;
    document.getElementById('search-out').innerHTML = "Searching...";
    
    // NIP-19
    if(q.startsWith('npub')) {
        try {
            const d = window.NostrTools.nip19.decode(q);
            Object.values(pool).forEach(w => sub(w, "search", { kinds:[1], authors:[d.data], limit:10 }));
        } catch(e){}
    } else {
        Object.values(pool).forEach(w => sub(w, "search", { kinds:[1], search:q, limit:10 }));
    }
}
function renderSearch(ev) {
    const el = document.getElementById('search-out');
    if(el.innerHTML === 'Searching...') el.innerHTML = '';
    el.innerHTML += renderCard(ev);
}

// --- LOGIN ---
async function loginExt() {
    if(!window.nostr) return alert("No Extension");
    myPub = await window.nostr.getPublicKey();
    localStorage.setItem('mbit_pub', myPub);
    location.reload();
}
function loginKey() {
    const k = document.getElementById('pk-input').value;
    try {
        const d = window.NostrTools.nip19.decode(k);
        myPriv = d.data;
        myPub = window.NostrTools.getPublicKey(myPriv);
        localStorage.setItem('mbit_priv', myPriv);
        localStorage.setItem('mbit_pub', myPub);
        location.reload();
    } catch(e) { alert("Invalid key"); }
}
function logout() { localStorage.clear(); location.reload(); }

init();
</script>
</body>
</html>
