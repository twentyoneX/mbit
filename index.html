<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>mBIT v4 (Stable)</title>
<script src="https://unpkg.com/nostr-tools@1.17.0/lib/nostr.bundle.js"></script>
<style>
    :root{--bg:#000;--txt:#fff;--acc:#00FF41;--brd:#333;--pnl:#111;}
    body{background:var(--bg);color:var(--txt);font-family:monospace;margin:0;padding:10px;padding-bottom:80px;max-width:600px;margin:0 auto;}
    header{text-align:center;border-bottom:1px solid var(--brd);padding:15px;margin-bottom:15px;}
    h1{margin:0;text-shadow:0 0 5px var(--acc);}
    .nav{margin-top:10px;display:flex;justify-content:center;gap:15px;cursor:pointer;user-select:none;}
    .nav span:hover{color:var(--acc);text-decoration:underline;}
    .panel{display:none;}
    .panel.active{display:block;}
    
    .post{border:1px solid var(--brd);padding:15px;margin-bottom:15px;background:#050505;word-break:break-word;}
    .post-meta{color:#888;font-size:0.8em;margin-bottom:8px;display:flex;align-items:center;gap:10px;}
    .avatar{width:30px;height:30px;background:#333;border-radius:50%;object-fit:cover;}
    .post-content{font-size:1em;line-height:1.5;white-space:pre-wrap;}
    .post-actions{margin-top:10px;border-top:1px solid #222;padding-top:10px;display:flex;gap:10px;}
    
    button{background:var(--txt);color:#000;border:none;padding:5px 10px;font-weight:bold;cursor:pointer;text-transform:uppercase;}
    button:hover{opacity:0.8;}
    button.sec{background:#333;color:#fff;border:1px solid #555;}
    
    .thread-parent{border-left:4px solid var(--acc);background:#081008;}
    .thread-reply{margin-left:20px;border-left:2px solid #333;}
    
    .notif-item{padding:15px;border-bottom:1px solid var(--brd);cursor:pointer;}
    .notif-item:hover{background:#111;}
    
    .media{max-width:100%;margin-top:10px;border:1px solid #333;}
    
    .fab{position:fixed;bottom:80px;right:20px;width:60px;height:60px;background:var(--acc);color:#000;border-radius:50%;font-size:30px;display:flex;justify-content:center;align-items:center;cursor:pointer;box-shadow:0 0 10px var(--acc);}
    
    .footer{position:fixed;bottom:0;left:0;width:100%;background:#000;border-top:1px solid var(--brd);display:flex;justify-content:space-around;padding:15px;}
    .footer span{cursor:pointer;font-weight:bold;}
    
    .modal-bg{position:fixed;top:0;left:0;width:100%;height:100%;background:#000000e0;display:none;align-items:center;justify-content:center;z-index:999;}
    .modal-content{background:#111;border:1px solid var(--acc);padding:20px;width:90%;max-width:500px;}
    textarea{width:100%;background:#000;color:#fff;border:1px solid #333;padding:10px;font-family:inherit;}
    input{width:100%;background:#000;color:#fff;border:1px solid #333;padding:10px;margin-bottom:10px;}
</style>
</head>
<body>

<header>
    <h1>mBIT</h1>
    <div class="nav">
        <span onclick="route('feed')">#FEED</span>
        <span onclick="route('login')">#LOGIN</span>
        <span onclick="route('profile')">#PROFILE</span>
        <span onclick="route('settings')">#SETTINGS</span>
    </div>
</header>

<!-- PANELS -->
<div id="feed-panel" class="panel active">
    <div id="feed-stream">Loading feed...</div>
</div>

<div id="thread-panel" class="panel">
    <button class="sec" onclick="route('feed')">&lt; BACK</button>
    <h3 style="border-bottom:1px dashed #333;padding-bottom:10px;">>> THREAD VIEW</h3>
    <div id="thread-parent"></div> <!-- The note above (if any) -->
    <div id="thread-main"></div>   <!-- The note you clicked -->
    <div style="margin:20px 0;opacity:0.5;font-size:0.8em;">REPLIES:</div>
    <div id="thread-replies"></div> <!-- The comments -->
</div>

<div id="notifications-panel" class="panel">
    <h3>>> NOTIFICATIONS</h3>
    <div id="notif-list">Loading...</div>
</div>

<div id="search-panel" class="panel">
    <h3>>> SEARCH</h3>
    <div style="display:flex;gap:10px">
        <input id="search-in" placeholder="Search content or npub...">
        <button onclick="runSearch()">GO</button>
    </div>
    <div id="search-out" style="margin-top:20px;"></div>
</div>

<div id="login-panel" class="panel">
    <h3>>> LOGIN</h3>
    <button onclick="loginExt()" style="width:100%;background:#9b59b6;color:fff;margin-bottom:15px;">EXTENSION (ALBY)</button>
    <input id="nsec-in" placeholder="nsec...">
    <button onclick="loginKey()">LOGIN WITH KEY</button>
</div>

<div id="profile-panel" class="panel">
    <button class="sec" onclick="route('feed')">&lt; BACK</button>
    <div id="my-profile-data"></div>
</div>

<!-- FOOTER -->
<div class="footer">
    <span onclick="route('feed')">#HOME</span>
    <span onclick="route('search')">#SEARCH</span>
    <span onclick="route('notifications')">#NOTIFS</span>
</div>

<!-- COMPOSER -->
<div class="fab" onclick="showComposer()">+</div>
<div id="composer" class="modal-bg">
    <div class="modal-content">
        <div id="reply-label" style="color:#888;margin-bottom:5px;font-size:0.8em;"></div>
        <textarea id="note-body" rows="5" placeholder="Broadcast message..."></textarea>
        <div style="margin-top:10px;display:flex;gap:10px;">
            <button class="sec" style="flex:1" onclick="hideComposer()">CANCEL</button>
            <button style="flex:1" onclick="publish()">SEND</button>
        </div>
    </div>
</div>

<script>
// --- CORE VARIABLES ---
const RELAYS = ['wss://relay.damus.io', 'wss://relay.primal.net', 'wss://nos.lol'];
const pool = {};
const events = new Map(); // Global event cache (id -> event)
const profiles = {};      // Pubkey -> Metadata

let myPub = localStorage.getItem('mbit_pub');
let myPriv = localStorage.getItem('mbit_priv');

let viewingThreadId = null;
let replyToId = null;

// --- INITIALIZATION ---
function init() {
    RELAYS.forEach(url => {
        try {
            const ws = new WebSocket(url);
            pool[url] = ws;
            ws.onopen = () => {
                // Subscribe to Global Feed
                sub(ws, "feed", { kinds: [1], limit: 20 });
                // Subscribe to Notifications if logged in
                if(myPub) sub(ws, "notifs", { '#p': [myPub], kinds: [1,6,7,9735], limit: 50 });
            };
            ws.onmessage = (msg) => handleMessage(msg);
        } catch(e) { console.error(e); }
    });
}

function sub(ws, id, filter) {
    ws.send(JSON.stringify(["REQ", id, filter]));
}

function handleMessage(msg) {
    const data = JSON.parse(msg.data);
    if(data[0] === 'EVENT') {
        const subId = data[1];
        const ev = data[2];
        
        // Cache every event
        if(!events.has(ev.id)) {
            events.set(ev.id, ev);
            
            // Profile Metadata
            if(ev.kind === 0) {
                try { profiles[ev.pubkey] = JSON.parse(ev.content); } catch(e){}
            }

            // UI Updates based on subId
            if(subId === 'feed') renderFeed();
            if(subId === 'notifs') renderNotifications();
            if(subId.startsWith('thread')) renderThreadUI(); // Live update thread
            if(subId === 'search') renderSearch(ev);
        }
    }
}

// --- ROUTING ---
function route(page) {
    document.querySelectorAll('.panel').forEach(el => el.classList.remove('active'));
    document.getElementById(page + '-panel').classList.add('active');
    
    if(page === 'feed') renderFeed();
    if(page === 'notifications') renderNotifications();
    if(page === 'profile') renderMyProfile();
}

// --- FEED LOGIC ---
function renderFeed() {
    const feedEvents = Array.from(events.values())
        .filter(e => e.kind === 1) // Text notes only for main feed
        .sort((a,b) => b.created_at - a.created_at)
        .slice(0, 50);
        
    document.getElementById('feed-stream').innerHTML = feedEvents.map(e => makeCard(e)).join('');
}

// --- THREAD LOGIC (THE FIX) ---
function openThread(id) {
    // 1. If it's a Like (7) or Repost (6), find the original note ID
    const ev = events.get(id);
    if(ev && (ev.kind === 7 || ev.kind === 6)) {
        const target = ev.tags.find(t => t[0] === 'e');
        if(target) {
            id = target[1]; // Switch ID to the actual note
        }
    }

    viewingThreadId = id;
    route('thread');
    
    document.getElementById('thread-main').innerHTML = '<div style="padding:20px;text-align:center">Loading...</div>';
    document.getElementById('thread-replies').innerHTML = '';
    document.getElementById('thread-parent').innerHTML = '';

    // Ask relays for data
    Object.values(pool).forEach(ws => {
        if(ws.readyState === 1) {
            // Get Main Note
            sub(ws, "thread_main", { ids: [id] });
            // Get Replies
            sub(ws, "thread_replies", { '#e': [id], kinds: [1], limit: 100 });
        }
    });

    renderThreadUI();
}

function renderThreadUI() {
    if(!viewingThreadId) return;

    // 1. Render Main Note
    const main = events.get(viewingThreadId);
    if(main) {
        document.getElementById('thread-main').innerHTML = makeCard(main, true);
        
        // Check for Parent (Context)
        const parentTag = main.tags.find(t => t[0] === 'e' && t[3] === 'reply') || main.tags.find(t => t[0] === 'e'); 
        // Logic: Try to find explicit 'reply' marker, otherwise just grab first 'e' tag
        
        if(parentTag) {
            const pId = parentTag[1];
            const parent = events.get(pId);
            if(parent) {
                document.getElementById('thread-parent').innerHTML = `
                    <div style="font-size:0.8em;opacity:0.7;margin-bottom:5px;">Replying to:</div>
                    ${makeCard(parent)}
                    <div style="text-align:center;font-size:1.5em;line-height:0.5;">|</div>
                `;
            } else {
                // Fetch parent if missing
                 Object.values(pool).forEach(ws => sub(ws, "thread_parent", { ids: [pId] }));
            }
        }
    }

    // 2. Render Replies
    const replies = Array.from(events.values()).filter(e => 
        e.kind === 1 && 
        e.tags.some(t => t[0] === 'e' && t[1] === viewingThreadId)
    ).sort((a,b) => a.created_at - b.created_at);

    document.getElementById('thread-replies').innerHTML = replies.map(e => makeCard(e)).join('');
}

// --- NOTIFICATIONS LOGIC (FIXED) ---
function renderNotifications() {
    const notifs = Array.from(events.values())
        .filter(e => e.kind !== 0 && e.tags.some(t => t[0] === 'p' && t[1] === myPub))
        .sort((a,b) => b.created_at - a.created_at)
        .slice(0, 50);

    if(notifs.length === 0) {
        document.getElementById('notif-list').innerHTML = "No notifications yet.";
        return;
    }

    document.getElementById('notif-list').innerHTML = notifs.map(e => {
        const p = profiles[e.pubkey] || {};
        const name = p.name || e.pubkey.substring(0,8);
        
        // Zap (9735)
        if(e.kind === 9735) {
            let amount = "some";
            try { 
                const bolt11 = e.tags.find(t => t[0] === 'bolt11'); // simplified
                const desc = JSON.parse(e.tags.find(t=>t[0]==='description')[1]);
                const millisats = desc.tags.find(t=>t[0]==='amount')[1];
                amount = Math.floor(millisats/1000);
            } catch(err){}
            const target = e.tags.find(t=>t[0]==='e')?.[1];
            return `<div class="notif-item" onclick="openThread('${target}')"><span style="color:#f1c40f">‚ö°</span> <b>${amount} sats</b> from ${name}</div>`;
        }
        
        // Like (7)
        if(e.kind === 7) {
            const target = e.tags.find(t=>t[0]==='e')?.[1];
            return `<div class="notif-item" onclick="openThread('${target}')"><span style="color:#e74c3c">‚ù§</span> <b>${name}</b> liked your note</div>`;
        }

        // Repost (6)
        if(e.kind === 6) {
            const target = e.tags.find(t=>t[0]==='e')?.[1];
            return `<div class="notif-item" onclick="openThread('${target}')"><span style="color:#2ecc71">‚Üª</span> <b>${name}</b> reposted your note</div>`;
        }

        // Reply (1)
        if(e.kind === 1) {
            return `<div class="notif-item" onclick="openThread('${e.id}')">üí¨ Reply from <b>${name}</b>:<br><span style="opacity:0.8">${e.content}</span></div>`;
        }
        
        return '';
    }).join('');
}

// --- UTILS ---
function makeCard(ev, isMain) {
    if(!ev) return '';
    const p = profiles[ev.pubkey] || {};
    const name = p.display_name || p.name || ev.pubkey.substring(0,8);
    const pic = p.picture || '';
    
    // Parse content for images
    let content = ev.content
        .replace(/</g, "&lt;")
        .replace(/(https?:\/\/[^\s]+\.(jpg|jpeg|png|gif|webp))/gi, '<img src="$1" class="media">')
        .replace(/(https?:\/\/[^\s]+\.(mp4|mov))/gi, '<video controls src="$1" class="media"></video>');

    const style = isMain ? 'border:2px solid var(--acc); background:#0a0a0a;' : '';

    return `
    <div class="post" style="${style}">
        <div class="post-meta" onclick="viewingThreadId='${ev.id}';route('thread');">
            ${pic ? `<img src="${pic}" class="avatar">` : `<div class="avatar"></div>`}
            <b style="color:#fff">${name}</b>
            <span style="margin-left:auto">${new Date(ev.created_at*1000).toLocaleTimeString()}</span>
        </div>
        <div class="post-content" onclick="openThread('${ev.id}')">${content}</div>
        <div class="post-actions">
            <button class="sec" onclick="prepReply('${ev.id}')">REPLY</button>
            <button class="sec" onclick="publishLike('${ev.id}')">LIKE</button>
            <button class="sec" onclick="zap('${p.lud16}')">ZAP</button>
        </div>
    </div>`;
}

// --- SEARCH ---
function runSearch() {
    const q = document.getElementById('search-in').value;
    document.getElementById('search-out').innerHTML = "Searching...";
    
    // NIP-19 check
    if(q.startsWith('npub')) {
        try {
            const { data } = window.NostrTools.nip19.decode(q);
            // Search profile notes
            Object.values(pool).forEach(ws => sub(ws, "search", { kinds:[1], authors:[data], limit:20 }));
            return;
        } catch(e) {}
    }

    // Text search
    Object.values(pool).forEach(ws => sub(ws, "search", { kinds:[1], search: q, limit:20 }));
}

function renderSearch(ev) {
    const box = document.getElementById('search-out');
    if(box.innerHTML === "Searching...") box.innerHTML = "";
    box.innerHTML += makeCard(ev);
}

// --- ACTIONS ---
function showComposer() { 
    if(!myPub) return alert("Please Login First");
    document.getElementById('composer').style.display = 'flex'; 
}
function hideComposer() { document.getElementById('composer').style.display = 'none'; replyToId = null; document.getElementById('reply-label').innerText=''; }

function prepReply(id) {
    replyToId = id;
    document.getElementById('reply-label').innerText = "Replying to " + id.substring(0,8);
    showComposer();
}

async function publish() {
    const text = document.getElementById('note-body').value;
    if(!text) return;

    const ev = {
        kind: 1,
        created_at: Math.floor(Date.now()/1000),
        tags: [],
        content: text,
        pubkey: myPub
    };

    if(replyToId) {
        ev.tags.push(['e', replyToId, '', 'reply']);
    }

    try {
        if(window.nostr) {
            const signed = await window.nostr.signEvent(ev);
            broadcast(signed);
        } else if(myPriv) {
            ev.id = window.NostrTools.getEventHash(ev);
            ev.sig = window.NostrTools.signEvent(ev, myPriv);
            broadcast(ev);
        }
        hideComposer();
        document.getElementById('note-body').value = '';
    } catch(e) { alert("Error signing: " + e); }
}

async function publishLike(id) {
    if(!myPub) return alert("Login first");
    const ev = { kind:7, content:'+', tags:[['e',id]], created_at:Math.floor(Date.now()/1000), pubkey:myPub };
    if(window.nostr) {
        const signed = await window.nostr.signEvent(ev);
        broadcast(signed);
        alert("Liked!");
    }
}

function broadcast(ev) {
    Object.values(pool).forEach(ws => {
        if(ws.readyState === 1) ws.send(JSON.stringify(["EVENT", ev]));
    });
}

async function zap(lud16) {
    if(!lud16) return alert("No Lightning Address found for this user");
    window.open("lightning:"+lud16);
}

// --- IDENTITY ---
async function loginExt() {
    if(!window.nostr) return alert("Install Alby or Nos2x");
    myPub = await window.nostr.getPublicKey();
    localStorage.setItem('mbit_pub', myPub);
    localStorage.setItem('mbit_mode', 'ext');
    location.reload();
}

function loginKey() {
    const key = document.getElementById('nsec-in').value;
    try {
        const { data } = window.NostrTools.nip19.decode(key);
        myPriv = data;
        myPub = window.NostrTools.getPublicKey(myPriv);
        localStorage.setItem('mbit_priv', myPriv);
        localStorage.setItem('mbit_pub', myPub);
        location.reload();
    } catch(e) { alert("Invalid Key"); }
}

// --- START ---
init();
</script>
</body>
</html>
