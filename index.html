<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>mBIT</title>
<script src="https://unpkg.com/nostr-tools@1.17.0/lib/nostr.bundle.js"></script>
<style>
:root{--bg:#000;--txt:#fff;--pnl:#0a0a0a;--brd:#333;--acc:#00FF41;--fnt:16px;}
body{background:var(--bg);color:var(--txt);font-family:Courier,monospace;font-size:var(--fnt);margin:0;padding:10px;padding-bottom:80px;}
header{text-align:center;border-bottom:1px solid var(--brd);padding-bottom:10px;margin-bottom:20px;}
h1{margin:0;text-shadow:0 0 5px var(--acc);}
.nav{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;margin-top:10px;user-select:none;}
.nav span{cursor:pointer;opacity:0.7;} .nav span:hover{opacity:1;text-decoration:underline;color:var(--acc);}
.panel{border:1px dashed var(--brd);background:var(--pnl);padding:10px;margin-bottom:20px;}
.hidden{display:none!important;}
input,textarea,button,select{background:#000;color:#fff;border:1px solid var(--brd);padding:10px;width:100%;margin-bottom:10px;font-family:inherit;}
button{cursor:pointer;font-weight:bold;text-transform:uppercase;background:var(--txt);color:#000;}
button:hover{opacity:0.8;} button.sec{background:#222;color:#fff;}
.post{border-left:2px solid var(--brd);padding-left:10px;margin-bottom:25px;}
.meta{font-size:0.8em;color:#888;margin-bottom:5px;display:flex;align-items:center;cursor:pointer;}
.avatar{width:24px;height:24px;border-radius:50%;margin-right:8px;background:#222;}
.content{font-size:1em;line-height:1.4;white-space:pre-wrap;word-break:break-word;cursor:pointer;}
.actions{display:flex;gap:10px;margin-top:10px;opacity:0.8;}
.act-btn{background:0 0;border:1px solid #555;color:#ccc;padding:4px 8px;font-size:0.75em;width:auto;margin:0;}
.act-btn:hover{border-color:var(--acc);color:var(--acc);}
.media{max-width:100%;display:block;margin:10px 0;border:1px solid #333;}
.thread-p{border-left:4px solid var(--acc);background:#051005;padding:10px;margin-bottom:15px;}
.thread-a{border-left:2px dotted #555;padding:10px;margin-bottom:10px;opacity:0.8;font-size:0.9em;}
.notif{padding:12px;border-bottom:1px solid var(--brd);display:flex;gap:10px;align-items:center;cursor:pointer;}
.notif:hover{background:#111;}
.fab{position:fixed;bottom:70px;right:20px;width:50px;height:50px;background:var(--acc);color:#000;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:30px;cursor:pointer;z-index:99;}
.bar{position:fixed;bottom:0;left:0;width:100%;background:#000;border-top:1px solid var(--brd);display:flex;justify-content:space-around;padding:15px 0;z-index:90;}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:#000000d0;z-index:100;display:flex;justify-content:center;padding-top:50px;}
.m-content{background:#111;border:1px solid var(--acc);padding:20px;width:90%;max-width:600px;height:fit-content;}
</style>
</head>
<body>

<header>
    <h1>mBIT</h1>
    <div class="nav">
        <span onclick="go('feed')">#FEED</span> | 
        <span onclick="toggle('login')">#LOGIN</span> | 
        <span onclick="toggle('profile')">#PROFILE</span> | 
        <span onclick="toggle('settings')">#SETTINGS</span>
    </div>
</header>

<div id="main">
    <!-- FEED -->
    <div id="feed-panel">
        <button id="new-btn" class="hidden" onclick="renderFeed()" style="border-color:var(--acc);color:var(--acc)">>> LOAD NEW POSTS <<</button>
        <div id="feed-list"></div>
    </div>

    <!-- THREAD -->
    <div id="thread-panel" class="panel hidden">
        <button class="sec" onclick="go('feed')">&lt; #BACK</button>
        <h3>>> THREAD</h3>
        <div id="thread-content"></div>
    </div>

    <!-- NOTIFICATIONS -->
    <div id="notif-panel" class="panel hidden">
        <h3>>> NOTIFICATIONS</h3>
        <div style="display:flex;gap:5px;margin-bottom:10px;">
            <button class="sec" onclick="loadNotifs('all')">ALL</button>
            <button class="sec" onclick="loadNotifs('zaps')">ZAPS</button>
            <button class="sec" onclick="loadNotifs('mentions')">MENTIONS</button>
        </div>
        <div id="notif-list">Loading...</div>
    </div>

    <!-- SEARCH -->
    <div id="search-panel" class="panel hidden">
        <h3>>> SEARCH</h3>
        <div style="display:flex;gap:5px;">
            <input id="search-q" placeholder="npub, #tag, or text">
            <button onclick="doSearch()" style="width:auto">GO</button>
        </div>
        <div id="search-res"></div>
    </div>

    <!-- LOGIN -->
    <div id="login-panel" class="panel hidden">
        <h3>>> IDENTITY</h3>
        <button onclick="loginExt()" style="background:#9b59b6;color:#fff;margin-bottom:10px">EXTENSION LOGIN</button>
        <input id="pk-in" placeholder="nsec...">
        <button onclick="loginKey()">LOGIN WITH KEY</button>
        <div id="user-display" class="hidden" style="margin-top:20px;word-break:break-all;font-size:0.8em;"></div>
    </div>

    <!-- PROFILE EDITOR -->
    <div id="profile-panel" class="panel hidden">
        <button class="sec" onclick="go('feed')">&lt; #BACK</button>
        <div id="my-profile-view"></div>
    </div>

    <!-- SETTINGS -->
    <div id="settings-panel" class="panel hidden">
        <h3>>> SETTINGS</h3>
        <button onclick="addRelayPrompt()">ADD RELAY</button>
        <div id="relay-list" style="margin-top:10px;font-size:0.8em;opacity:0.8;"></div>
        <br><button class="sec" onclick="go('feed')">CLOSE</button>
    </div>
</div>

<div class="fab" onclick="openComposer()">+</div>

<!-- COMPOSER -->
<div id="composer" class="modal hidden">
    <div class="m-content">
        <div id="reply-ctx" class="hidden" style="border-left:2px solid var(--acc);padding:5px;margin-bottom:10px;font-size:0.8em;opacity:0.8;"></div>
        <textarea id="compose-txt" rows="5" placeholder="Signal..."></textarea>
        <div style="display:flex;gap:10px">
            <button class="sec" style="flex:1" onclick="closeComposer()">CANCEL</button>
            <button style="flex:2" onclick="publishNote()">SEND</button>
        </div>
    </div>
</div>

<div class="bar">
    <span class="footer-item" onclick="go('feed')">#HOME</span>
    <span class="footer-item" onclick="toggle('search')">#SEARCH</span>
    <span class="footer-item" onclick="toggle('notif')">#NOTIFS</span>
</div>

<script>
// --- STATE & CONFIG ---
const RELAYS = JSON.parse(localStorage.getItem('mbit_relays')) || ['wss://relay.damus.io','wss://relay.primal.net','wss://nos.lol','wss://relay.nostr.band'];
const POOL = {}; 
let EVENTS = [], THREAD = [], NOTIFS = [];
let ME = { pub: localStorage.getItem('npub'), priv: localStorage.getItem('nsec') };
let PROFILES = {};
let REPLY_TO = null;

// --- INIT ---
function init() {
    if(ME.pub) {
        document.getElementById('user-display').innerText = "Logged in: " + ME.pub.substring(0,10)+"...";
        document.getElementById('user-display').classList.remove('hidden');
    }
    renderRelays();
    RELAYS.forEach(connect);
    
    // Auto-update feed
    setInterval(() => {
        if(!document.getElementById('feed-panel').classList.contains('hidden')) renderFeed();
    }, 5000);
}

// --- NETWORK ---
function connect(url) {
    if(POOL[url]) return;
    try {
        const ws = new WebSocket(url);
        POOL[url] = ws;
        ws.onopen = () => {
            // Sub Feed
            ws.send(JSON.stringify(["REQ", "feed", { kinds: [1], limit: 20 }]));
            // Sub Notifs if logged in
            if(ME.pub) ws.send(JSON.stringify(["REQ", "notifs", { '#p': [ME.pub], limit: 50 }]));
        };
        ws.onmessage = (e) => {
            const d = JSON.parse(e.data);
            if(d[0] === 'EVENT') handleEvent(d[2], d[1]);
        };
    } catch(e){console.error(e)}
}

function handleEvent(ev, subId) {
    if(subId === 'feed') {
        if(!EVENTS.find(e=>e.id===ev.id)) { EVENTS.push(ev); document.getElementById('new-btn').classList.remove('hidden'); }
    }
    if(subId === 'notifs') {
        if(!NOTIFS.find(e=>e.id===ev.id)) NOTIFS.push(ev);
    }
    if(subId.startsWith('thread')) {
        if(!THREAD.find(e=>e.id===ev.id)) {
            THREAD.push(ev);
            renderThread(window.currentThreadId); // Live update thread
        }
    }
    if(subId.startsWith('meta')) {
        try { PROFILES[ev.pubkey] = JSON.parse(ev.content); updateUI(); } catch(e){}
    }
    // Fetch profile if missing
    if(!PROFILES[ev.pubkey]) {
        PROFILES[ev.pubkey] = {}; // placeholder
        Object.values(POOL).forEach(w => w.send(JSON.stringify(["REQ", "meta_"+ev.pubkey.substring(0,5), { kinds:[0], authors:[ev.pubkey], limit:1 }])));
    }
}

// --- UI NAVIGATION ---
function go(panel) {
    document.querySelectorAll('.panel, #feed-panel').forEach(e => e.classList.add('hidden'));
    document.getElementById(panel === 'feed' ? 'feed-panel' : panel + '-panel').classList.remove('hidden');
    if(panel === 'feed') renderFeed();
}
function toggle(panel) { go(panel); if(panel === 'notif') loadNotifs('all'); }

// --- FEED ---
function renderFeed() {
    EVENTS.sort((a,b) => b.created_at - a.created_at);
    document.getElementById('feed-list').innerHTML = EVENTS.slice(0,50).map(drawNote).join('');
    document.getElementById('new-btn').classList.add('hidden');
}

// --- THREAD ENGINE (FIXED) ---
window.currentThreadId = null;

function openThread(id) {
    console.log("Opening thread:", id);
    window.currentThreadId = id;
    go('thread');
    document.getElementById('thread-content').innerHTML = '<div style="opacity:0.5">Loading thread context...</div>';
    
    THREAD = []; // Clear previous
    
    // Check Cache
    const cached = [...EVENTS, ...NOTIFS].find(e => e.id === id);
    if(cached) THREAD.push(cached);

    // Fetch Target + Replies + Parent
    Object.values(POOL).forEach(ws => {
        if(ws.readyState === 1) {
            // Get the note
            ws.send(JSON.stringify(["REQ", "thread_root", { kinds:[1], ids:[id] }]));
            // Get replies
            ws.send(JSON.stringify(["REQ", "thread_replies", { kinds:[1], '#e':[id], limit:100 }]));
            
            // If we have cached note, check for parent immediately
            if(cached) fetchParent(cached);
        }
    });

    // Render what we have
    renderThread(id);
}

function fetchParent(note) {
    // Find parent ID using NIP-10 logic fallback
    let parentId = null;
    const eTags = note.tags.filter(t => t[0] === 'e');
    const replyTag = eTags.find(t => t[3] === 'reply');
    if (replyTag) parentId = replyTag[1];
    else if (eTags.length > 0) parentId = eTags[eTags.length - 1][1]; // Last tag

    if(parentId) {
        Object.values(POOL).forEach(ws => {
            ws.send(JSON.stringify(["REQ", "thread_parent", { kinds:[1], ids:[parentId] }]));
        });
    }
}

function renderThread(rootId) {
    const root = THREAD.find(e => e.id === rootId);
    let html = '';

    // 1. Ancestor (Context)
    if(root) {
        const eTags = root.tags.filter(t => t[0] === 'e');
        const parentId = eTags.length > 0 ? eTags[eTags.length-1][1] : null;
        if(parentId) {
            const parent = THREAD.find(e => e.id === parentId);
            if(parent) {
                html += `<div class="thread-a">In Reply to:<br>${drawNote(parent, true)}</div>`;
            } else {
                html += `<div class="thread-a" style="opacity:0.5">[ Loading Parent Note... ]</div>`;
            }
        }
        // 2. Main Note
        html += `<div class="thread-p">${drawNote(root, false)}</div>`;
    } else {
        html += `<div style="padding:20px;text-align:center">Loading selected note...</div>`;
    }

    // 3. Replies
    const replies = THREAD.filter(e => {
        // Simple check: does this note tag the root?
        return e.id !== rootId && e.tags.some(t => t[0] === 'e' && t[1] === rootId);
    });
    replies.sort((a,b) => a.created_at - b.created_at);

    html += `<h4>Replies (${replies.length})</h4>`;
    html += replies.map(e => drawNote(e, true)).join('');

    document.getElementById('thread-content').innerHTML = html;
}

// --- NOTIFICATIONS (FIXED) ---
function loadNotifs(filter) {
    if(!ME.pub) return document.getElementById('notif-list').innerHTML = "Please Login.";
    
    NOTIFS.sort((a,b) => b.created_at - a.created_at);
    
    let list = NOTIFS;
    if(filter === 'zaps') list = NOTIFS.filter(e => e.kind === 9735);
    if(filter === 'mentions') list = NOTIFS.filter(e => e.kind === 1);

    document.getElementById('notif-list').innerHTML = list.map(e => {
        const p = PROFILES[e.pubkey] || {};
        const name = p.name || e.pubkey.substring(0,6);
        
        // ZAP
        if(e.kind === 9735) {
            let amount = 0;
            try { 
                const desc = JSON.parse(e.tags.find(t=>t[0]==='description')[1]); 
                amount = Math.floor(desc.tags.find(t=>t[0]==='amount')[1]/1000);
            } catch(err){}
            const target = e.tags.find(t=>t[0]==='e')?.[1];
            return `<div class="notif" onclick="openThread('${target}')"><span style="color:gold">‚ö°</span> ${amount} sats from <b>${name}</b> <br><small>>> view note</small></div>`;
        }
        // LIKE
        if(e.kind === 7) {
            const target = e.tags.find(t=>t[0]==='e')?.[1];
            return `<div class="notif" onclick="openThread('${target}')"><span style="color:red">‚ù§</span> <b>${name}</b> liked your post <br><small>>> view note</small></div>`;
        }
        // REPLY
        if(e.kind === 1) {
            return `<div class="notif" style="display:block"><div>üí¨ Reply from <b>${name}</b>:</div>${drawNote(e, true)}</div>`;
        }
        return '';
    }).join('');
}

// --- DRAWING ---
function drawNote(e, compact) {
    const p = PROFILES[e.pubkey] || {};
    const name = p.display_name || p.name || e.pubkey.substring(0,8);
    const pic = p.picture;
    let content = e.content
        .replace(/</g, "&lt;")
        .replace(/(https?:\/\/[^\s]+\.(jpg|jpeg|png|gif))/g, '<img src="$1" class="media">');

    return `
    <div class="post" style="border-color:${compact?'#333':'var(--acc)'}; margin-bottom:${compact?'10px':'25px'}">
        <div class="meta" onclick="openThread('${e.id}')">
            ${pic ? `<img src="${pic}" class="avatar">` : '<div class="avatar"></div>'}
            <span style="color:var(--txt);font-weight:bold">${name}</span>
            <span style="margin-left:auto">${new Date(e.created_at*1000).toLocaleTimeString()}</span>
        </div>
        <div class="content" onclick="openThread('${e.id}')">${content}</div>
        <div class="actions">
            <button class="act-btn" onclick="prepReply('${e.id}')">REPLY</button>
            <button class="act-btn" onclick="react('${e.id}', 7)">LIKE</button>
            <button class="act-btn" onclick="zap('${p.lud16}', '${e.pubkey}')">ZAP</button>
        </div>
    </div>`;
}

// --- SEARCH ---
function doSearch() {
    const q = document.getElementById('search-q').value;
    if(q.startsWith('npub')) {
        try {
            const d = window.NostrTools.nip19.decode(q);
            // Just sub to this user
            Object.values(POOL).forEach(ws => ws.send(JSON.stringify(["REQ", "search", { kinds:[1], authors:[d.data], limit:10 }])));
        } catch(e){ alert('Invalid NPUB'); }
    } else {
        Object.values(POOL).forEach(ws => ws.send(JSON.stringify(["REQ", "search", { kinds:[1], search:q, limit:10 }])));
    }
    document.getElementById('search-res').innerHTML = "Searching relays...";
    // Search results come in via handleEvent -> feed logic. 
    // For simplicity in this v1, search fills the main events array or specific search array
    // Here we will just override the feed rendering momentarily
    setTimeout(() => {
         const res = EVENTS.filter(e => e.content.includes(q)); // Client side filter fallback
         document.getElementById('search-res').innerHTML = res.map(drawNote).join('');
    }, 1500);
}

// --- COMPOSER ---
function openComposer() { document.getElementById('composer').classList.remove('hidden'); }
function closeComposer() { document.getElementById('composer').classList.add('hidden'); REPLY_TO=null; document.getElementById('reply-ctx').classList.add('hidden'); }
function prepReply(id) { 
    REPLY_TO = id; 
    openComposer(); 
    document.getElementById('reply-ctx').classList.remove('hidden');
    document.getElementById('reply-ctx').innerText = "Replying to " + id.substring(0,8);
}
async function publishNote() {
    if(!ME.priv && !window.nostr) return alert("Login first");
    const txt = document.getElementById('compose-txt').value;
    const ev = {
        kind: 1,
        created_at: Math.floor(Date.now()/1000),
        tags: REPLY_TO ? [['e', REPLY_TO, '', 'reply']] : [],
        content: txt,
        pubkey: ME.pub
    };
    
    if(ME.priv) {
        ev.id = window.NostrTools.getEventHash(ev);
        ev.sig = window.NostrTools.signEvent(ev, ME.priv);
    } else {
        const signed = await window.nostr.signEvent(ev);
        ev.id = signed.id; ev.sig = signed.sig;
    }
    
    Object.values(POOL).forEach(ws => ws.send(JSON.stringify(["EVENT", ev])));
    closeComposer();
    document.getElementById('compose-txt').value = "";
}

// --- UTILS ---
function loginKey() {
    const key = document.getElementById('pk-in').value;
    if(key.startsWith('nsec')) {
        const d = window.NostrTools.nip19.decode(key);
        ME.priv = d.data;
        ME.pub = window.NostrTools.getPublicKey(ME.priv);
    } else { ME.priv = key; ME.pub = window.NostrTools.getPublicKey(key); }
    localStorage.setItem('nsec', ME.priv);
    localStorage.setItem('npub', ME.pub);
    location.reload();
}
async function loginExt() {
    if(!window.nostr) return alert("No Extension");
    ME.pub = await window.nostr.getPublicKey();
    localStorage.setItem('npub', ME.pub);
    location.reload();
}
function logout() { localStorage.clear(); location.reload(); }
function updateUI(){ if(document.getElementById('thread-panel').classList.contains('hidden') === false) renderThread(window.currentThreadId); }
function renderRelays() { document.getElementById('relay-list').innerText = RELAYS.join(', '); }

init();
</script>
</body>
</html>
